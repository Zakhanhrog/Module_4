<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
  <title th:text="#{${pageTitle}}">Memory Form</title>
</head>
<body>
<div layout:fragment="content">
  <h2 th:text="#{${pageTitle}}">Create/Edit Memory</h2>

  <form th:action="${formAction}" th:object="${memoryDto}" method="post" enctype="multipart/form-data">
    <input type="hidden" th:if="${memoryDto.id}" th:field="*{id}" />

    <div class="mb-3">
      <label for="title" class="form-label" th:text="#{memory.title}">Title</label>
      <input type="text" class="form-control" id="title" th:field="*{title}"
             th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''" required>
      <div th:if="${#fields.hasErrors('title')}" class="invalid-feedback" th:errors="*{title}"></div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label" th:text="#{memory.description}">Description</label>
      <textarea class="form-control" id="description" th:field="*{description}" rows="5"></textarea>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="memoryDate" class="form-label" th:text="#{memory.date}">Date</label>
        <input type="date" class="form-control" id="memoryDate" th:field="*{memoryDate}"
               th:classappend="${#fields.hasErrors('memoryDate')} ? 'is-invalid' : ''" required>
        <div th:if="${#fields.hasErrors('memoryDate')}" class="invalid-feedback" th:errors="*{memoryDate}"></div>
      </div>
      <div class="col-md-6 mb-3">
        <label for="location" class="form-label" th:text="#{memory.location}">Location</label>
        <input type="text" class="form-control" id="location" th:field="*{location}">
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="emotionTypeId" class="form-label" th:text="#{memory.emotion}">Emotion</label>
        <select class="form-select" id="emotionTypeId" th:field="*{emotionTypeId}">
          <option value="" th:text="'-- ' + #{memory.emotion} + ' --'"></option>
          <option th:each="emotion : ${emotionTypes}"
                  th:value="${emotion.id}"
                  th:text="${#locale.language == 'en'} ? ${emotion.nameEn} : ${emotion.name}"></option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label for="status" class="form-label" th:text="#{memory.status}">Status</label>
        <select class="form-select" id="status" th:field="*{status}" required>
          <option th:each="s : ${T(com.example.memorymuseum.model.MemoryStatus).values()}"
                  th:value="${s}"
                  th:text="#{${'memory.status.' + s.name().toLowerCase()}}"></option>
        </select>
      </div>
    </div>

    <div class="mb-3">
      <label for="files" class="form-label" th:text="#{memory.files}">Attachments</label>
      <input type="file" class="form-control" id="files" name="files" multiple>
      <small class="form-text text-muted" th:text="'(Upload new files. Max size per file: ' + ${@environment.getProperty('spring.servlet.multipart.max-file-size')} + ')'"></small>
    </div>

    <div th:if="${memoryDto.id != null && memoryDto.existingFiles != null && !memoryDto.existingFiles.isEmpty()}" class="mb-3">
      <h5 th:text="#{memory.files.current}">Current Files</h5>
      <div th:each="file, iterStat : *{existingFiles}" class="mb-2 p-2 border rounded">
        <input type="hidden" th:name="'existingFiles[' + ${iterStat.index} + '].id'" th:value="${file.id}" />
        <input type="hidden" th:name="'existingFiles[' + ${iterStat.index} + '].filePath'" th:value="${file.filePath}" />
        <span th:text="${file.originalFileName}">filename.jpg</span>
        -
        <a th:href="${file.filePath}" target="_blank">View</a>
        <div class="form-check form-check-inline float-end">
          <input class="form-check-input" type="checkbox" th:id="'deleteFile' + ${file.id}" th:name="filesToDeleteIds" th:value="${file.id}">
          <label class="form-check-label" th:for="'deleteFile' + ${file.id}" th:text="#{memory.files.delete}">Delete</label>
        </div>
        <!-- Basic preview for images -->
        <div th:if="${file.filePath != null && (file.filePath.endsWith('.png') || file.filePath.endsWith('.jpg') || file.filePath.endsWith('.jpeg') || file.filePath.endsWith('.gif'))}" class="mt-2">
          <img th:src="${file.filePath}" alt="Preview" style="max-width: 100px; max-height: 100px;">
        </div>
      </div>
    </div>


    <button type="submit" class="btn btn-primary" th:text="${memoryDto.id == null} ? #{memory.submit.create} : #{memory.submit.update}">Submit</button>
    <a th:href="@{/memories/timeline}" class="btn btn-secondary">Cancel</a>
  </form>
</div>

<th:block layout:fragment="scripts">
  <!-- Add any page specific scripts here -->
</th:block>
</body>
</html>