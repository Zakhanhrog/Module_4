<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đặt Món Hôm Nay - Lunch App</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" th:href="@{/assets/css/style.css}"/>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container my-4">
  <h1 class="mb-3">Thực Đơn Hôm Nay</h1>

  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

  <div th:if="${!orderTimeAllowed}" class="alert alert-warning">
    <h5 class="alert-heading">Đã hết giờ đặt món!</h5>
    <p>Thời gian đặt món trong ngày đã kết thúc (Hạn chót: <strong th:text="${cutoffTime != null ? #temporals.format(cutoffTime, 'HH:mm') : ''}"></strong>).</p>
    <hr th:if="${hasOrderedToday}">
    <p class="mb-0" th:if="${hasOrderedToday}">Đơn hàng của bạn (Mã ĐH: <strong th:text="${todaysOrderId}"></strong>) đã được ghi nhận thành công.</p>
    <p class="mb-0" th:if="${!hasOrderedToday}">Bạn chưa đặt món hôm nay. Vui lòng quay lại vào ngày mai!</p>
  </div>

  <div th:if="${orderTimeAllowed && !hasOrderedToday && countdownSeconds != null && countdownSeconds > 0}" class="alert alert-info">
    Thời gian còn lại để đặt món: <strong id="countdown"></strong>
  </div>

  <div th:if="${orderTimeAllowed && hasOrderedToday}" class="alert alert-info d-flex justify-content-between align-items-center">
    <span>Bạn đã đặt món cho hôm nay (Mã ĐH: <strong th:text="${todaysOrderId}"></strong>).</span>
    <form th:action="@{/order/cancel-and-reorder}" method="post" class="mb-0">
      <button type="submit" class="btn btn-warning"
              onclick="return confirm('Bạn có chắc muốn hủy đơn hàng hiện tại để đặt lại không? Tiền sẽ được hoàn vào tài khoản.');">
        <i class="fa-solid fa-rotate-left"></i> Hủy & Đặt Lại
      </button>
    </form>
  </div>

  <form th:if="${orderTimeAllowed && !hasOrderedToday}" th:action="@{/order/place}" method="post" th:object="${orderRequestDto}" novalidate>
    <div th:if="${#lists.isEmpty(groupedFoodItems)}">
      <p class="alert alert-secondary">Hiện không có món nào trong thực đơn hôm nay. Vui lòng quay lại sau!</p>
    </div>

    <div th:each="entry : ${groupedFoodItems}" class="mb-5">
      <h2 class="mb-3" th:text="${entry.key.name}"></h2>
      <div th:if="${#lists.isEmpty(entry.value)}" class="alert alert-secondary">
        Danh mục này hiện chưa có món nào trong ngày hôm nay.
      </div>

      <!-- Thay đổi số cột ở đây -->
      <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
        <div th:each="item, iter : ${entry.value}" class="col">
          <div class="card h-100" th:classappend="${(item.dailyQuantity == null || item.dailyQuantity < 1) ? 'text-muted bg-light border-dashed' : 'shadow-sm'}">
            <div class="position-relative">
              <!-- Thêm class CSS mới cho ảnh -->
              <img th:if="${item.imageUrl != null && !item.imageUrl.isEmpty()}" th:src="${item.imageUrl}" class="card-img-top food-item-image-small" th:alt="${item.name}" th:classappend="${(item.dailyQuantity == null || item.dailyQuantity < 1) ? 'opacity-50' : ''}">
              <!-- Thêm class CSS mới cho ảnh mặc định -->
              <div th:unless="${item.imageUrl != null && !item.imageUrl.isEmpty()}" class="d-flex align-items-center justify-content-center food-item-no-image-small">
                <span>Không có ảnh</span>
              </div>
              <span th:if="${item.dailyQuantity != null && item.dailyQuantity > 0}" class="badge bg-success position-absolute top-0 end-0 m-2">Còn <span th:text="${item.dailyQuantity}"></span> suất</span>
              <span th:if="${item.dailyQuantity == null || item.dailyQuantity < 1}" class="badge bg-danger position-absolute top-0 end-0 m-2">Hết hàng</span>
            </div>
            <!-- Thêm class CSS mới cho card body -->
            <div class="card-body food-item-body-small">
              <h5 class="card-title" th:text="${item.name}"></h5>
              <p class="card-text fw-bold text-primary" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT') + ' VND'}"></p>
            </div>
            <!-- Thêm class CSS mới cho card footer -->
            <div class="card-footer food-item-footer-small">
              <div class="form-check">
                <input type="checkbox" class="form-check-input"
                       th:id="${'item_check_' + item.id}"
                       name="selectedItemCheck"
                       th:value="${item.id}"
                       th:checked="${orderRequestDto != null && orderRequestDto.selectedItems != null && orderRequestDto.selectedItems.?[foodItemId == '__${item.id}__'].size() > 0}"
                       th:disabled="${item.dailyQuantity == null || item.dailyQuantity < 1}">
                <label class="form-check-label" th:for="${'item_check_' + item.id}">
                  Chọn món này
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div th:if="${not #lists.isEmpty(groupedFoodItems)}" class="card shadow-sm mt-5">
      <div class="card-body">
        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
          <ul>
            <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
          </ul>
        </div>
        <div th:if="${#fields.hasErrors('selectedItems')}" class="alert alert-danger">
          <ul>
            <li th:each="err : ${#fields.errors('selectedItems')}" th:text="${err}"></li>
          </ul>
        </div>

        <div class="mb-3">
          <label for="orderNote" class="form-label">Ghi chú (ví dụ: không lấy hành, thêm ớt...)</label>
          <textarea id="orderNote" class="form-control" rows="3" th:field="*{note}" th:errorclass="is-invalid"></textarea>
          <div class="invalid-feedback" th:if="${#fields.hasErrors('note')}" th:errors="*{note}"></div>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fa-solid fa-cart-shopping"></i> Đặt Món Ngay
          </button>
        </div>
      </div>
    </div>
  </form>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/main.js}"></script>
<script th:if="${orderTimeAllowed && !hasOrderedToday && countdownSeconds != null && countdownSeconds > 0}" th:inline="javascript">
  var countdownElement=document.getElementById('countdown');
  var seconds=parseInt([[${countdownSeconds}]]);
  var timerInterval;
  function updateCountdown(){if(seconds<=0){clearInterval(timerInterval);location.reload();return}
    var h=Math.floor(seconds/3600);var m=Math.floor((seconds%3600)/60);var s=seconds%60;
    if(countdownElement){countdownElement.innerHTML=(h>0?h+" giờ ":"")+(m>0||h>0?String(m).padStart(2,'0')+" phút ":"")+String(s).padStart(2,'0')+" giây"}
    seconds--}
  if(seconds>0&&countdownElement){updateCountdown();timerInterval=setInterval(updateCountdown,1000)}else if(countdownElement){updateCountdown()}
</script>
</body>
</html>